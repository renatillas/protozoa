# Protozoa

A complete Protocol Buffers compiler and library for Gleam, providing full proto3 support with type-safe code generation.

[![Package Version](https://img.shields.io/hexpm/v/protozoa)](https://hex.pm/packages/protozoa)
[![Hex Docs](https://img.shields.io/badge/hex-docs-ffaff3)](https://hexdocs.pm/protozoa/)

## Features

✅ **Complete proto3 support** - Messages, enums, nested types, oneofs, maps, and repeated fields  
✅ **Import resolution** - Handles import statements with configurable search paths  
✅ **Type-safe codegen** - Generates idiomatic Gleam code with proper type safety  
✅ **CLI tools** - Easy-to-use command line interface with project integration  
✅ **All field types** - Full support for all scalar types, including fixed32/fixed64  
✅ **Cross-file imports** - Resolves dependencies between multiple proto files  

## Quick Start

### Installation

Add to your `gleam.toml`:

```toml
[dependencies]
protozoa = ">= 1.0.0 and < 2.0.0"
```

### Project Setup (Recommended)

1. **Create your proto files** in `src/[your-app]/proto/`:
```
your-project/
├── gleam.toml
└── src/
    └── myapp/
        └── proto/
            ├── user.proto
            └── message.proto
```

2. **Generate Gleam code** with the convenient CLI:
```bash
# Generate all proto files in your project
gleam run -m protozoa

# Check if proto files need regeneration (useful for CI)
gleam run -m protozoa check
```

3. **Use the generated code** in your Gleam modules:
```gleam
import myapp/proto/user
import myapp/proto/message

pub fn example() {
  let user = user.User(name: "Alice", age: 30, active: True)
  let encoded = user.encode_user(user)
  let decoded = user.decode_user(encoded)
  // ... use your proto types naturally in Gleam
}
```

### Manual Usage

For custom workflows, you can also use protozoa directly:

```bash
# Compile a specific proto file
gleam run -m protozoa -- message.proto ./output

# Use custom import paths
gleam run -m protozoa -- -I./common -I./vendor message.proto ./src

# Check if files need regeneration (full CLI mode)
gleam run -m protozoa -- --check
```

## CLI Reference

### Automatic Project Integration

The recommended approach is to use `gleam run -m protozoa`, which automatically:
- Detects your app name from `gleam.toml`
- Finds proto files in `src/[appname]/proto/` directories
- Generates output files alongside your proto files
- Includes safety headers for regeneration

```bash
# Generate all proto files (recommended)
gleam run -m protozoa

# Check if proto files have changed
gleam run -m protozoa check
```

### Manual Commands

For advanced usage or custom project structures:

```bash
# Basic usage
gleam run -m protozoa -- input.proto                    # Output to current directory
gleam run -m protozoa -- input.proto ./output           # Output to specific directory

# With import paths
gleam run -m protozoa -- -I./protos input.proto ./src   # Add import search paths
gleam run -m protozoa -- --proto_path=./common input.proto ./src

# Project automation  
gleam run -m protozoa -- --check                        # Check if regeneration needed
```

### Generated Files

All generated files include safety headers:

```gleam
//// Generated by Protozoa from user.proto
//// 
//// This file is auto-generated and can be safely deleted and regenerated.
//// To regenerate all proto files, run: gleam run -m protozoa
//// 
//// DO NOT EDIT THIS FILE MANUALLY - all changes will be lost on regeneration.
```

## Example

Given this proto file (`src/myapp/proto/user.proto`):

```protobuf
syntax = "proto3";

message User {
  string name = 1;
  int32 age = 2;
  bool active = 3;
  repeated string tags = 4;
}
```

Protozoa generates (`src/myapp/proto/user.gleam`):

```gleam
//// Generated by Protozoa from user.proto
//// 
//// This file is auto-generated and can be safely deleted and regenerated.
//// To regenerate all proto files, run: gleam run -m protozoa
//// 
//// DO NOT EDIT THIS FILE MANUALLY - all changes will be lost on regeneration.

import protozoa/decode
import protozoa/encode

pub type User {
  User(
    name: String,
    age: Int,
    active: Bool,
    tags: List(String)
  )
}

pub fn encode_user(user: User) -> BitArray {
  // ... generated encoder
}

pub fn decode_user(data: BitArray) -> Result(User, List(decode.DecodeError)) {
  // ... generated decoder  
}
```

## Roadmap / Missing Features

### Recently Completed ✅
- ✅ **Complete code generation** - All field types now supported
  - ✅ All repeated field type encoders (Fixed32, Fixed64, SFixed32, SFixed64, etc.)
  - ✅ All map key/value type combinations with proper Dict support
  - ✅ Comprehensive oneof field type variants
- ✅ **Import system** - Full cross-file import support
  - ✅ Basic import statements
  - ✅ Import path resolution with configurable search paths
  - ✅ Dependency management and type registry
- ✅ **CLI improvements** - Production-ready tooling
  - ✅ Project structure auto-detection (`src/[appname]/proto/`)
  - ✅ `gleam run -m proto` integration
  - ✅ `--check` mode for CI/build systems
  - ✅ Generated file safety headers

### High Priority
These features are essential for broader ecosystem compatibility:

- [x] **Well-known types** - Google's standard protobuf types ✅ COMPLETED
  - [x] `google.protobuf.Timestamp` - Full support with auto-import resolution
  - [x] `google.protobuf.Duration` - Full support with auto-import resolution
  - [x] `google.protobuf.Any` - Full support with auto-import resolution
  - [x] `google.protobuf.Struct` / `Value` - Full support with auto-import resolution
  - [x] `google.protobuf.Empty` - Full support with auto-import resolution
  - [x] Wrapper types (`StringValue`, `Int32Value`, etc.) - Full support with auto-import resolution
  - [x] Full integration with import system and code generation
- [x] **Field options** - Support field-level configuration ✅ COMPLETED  
  - [x] `deprecated` option - Parsing and deprecation warnings in generated code
  - [x] `json_name` option - Parsing support (ready for future JSON serialization)
  - [x] `packed` option - Parsing support (encoding already works)
  - [ ] Custom field options

### Medium Priority
Important for feature completeness and broader compatibility:

- ✅ **Services/RPC** - Support for service definitions
  - ✅ Service definition parsing
  - ✅ Method definitions
  - ✅ Code generation for service stubs
  - ✅ Streaming support detection (client/server/bidirectional)
- [ ] **Proto2 support** - Full proto2 compatibility
  - [ ] Required/optional field semantics
  - [ ] Default values
  - [ ] Extensions and extension ranges
  - [ ] Groups (deprecated but still used)
- [ ] **Unknown field handling** - Preserve unknown fields during decode/encode
- [ ] **File options** - Support file-level options
  - [ ] `java_package`, `java_outer_classname`
  - [ ] `optimize_for` (SPEED/CODE_SIZE/LITE_RUNTIME)
  - [ ] `go_package`
  - [ ] Custom file options
- [ ] **Recursive messages** - Full support for self-referential message types
- [ ] **JSON support** - JSON encoding/decoding as per proto3 JSON mapping

### Low Priority
Nice-to-have features and optimizations:

- [ ] **Advanced parsing**
  - [ ] Comment preservation in AST
  - [ ] Source location tracking
  - [ ] Better error messages with line numbers
- [ ] **Performance optimizations**
  - [ ] Lazy decoding for large messages
  - [ ] Streaming decode/encode for large data
  - [ ] Memory pooling for repeated allocations
  - [ ] Zero-copy decoding where possible
- [ ] **Validation**
  - [ ] Message validation against schema
  - [ ] Field constraint validation
  - [ ] Required field checking (proto2)
- [ ] **Tooling**
  - [ ] Proto file formatter
  - [ ] Proto file linter
  - [ ] Schema evolution checker
  - [ ] Documentation generator from proto comments
- [ ] **Extended type support**
  - [ ] Support for custom options
  - [ ] Experimental/beta proto3 features
  - [ ] Proto3 optional presence tracking

## Current Limitations

- Only supports proto3 syntax (proto2 partially works but not guaranteed)
- No service/RPC definitions
- No support for proto2 extensions
- Well-known types not yet implemented (though you can define your own equivalents)

## Development & Testing

```bash
# Run tests
gleam test

# Build the project
gleam build

# Test the CLI
gleam run -m protozoa -- --help
gleam run -m protozoa check
```

## Contributing

Contributions are welcome! The codebase is well-tested with comprehensive proto files covering all features. See the roadmap above for priority areas.

## License

This project is licensed under the Apache 2.0 License.
